DELIMITER $$

CREATE PROCEDURE ejecutarConsulta(IN consulta_id INT, IN parametro VARCHAR(255))
BEGIN
    CASE consulta_id
        -- Consulta 1: ¿Cuál es el libro más vendido en la tienda física?
        WHEN 1 THEN
            SELECT p.titulo_libro, COUNT(*) AS total_ventas
            FROM Pedido p
            GROUP BY p.titulo_libro
            ORDER BY total_ventas DESC;

        -- Consulta 2: ¿Cuál es la fecha donde ha habido más ventas?
        WHEN 2 THEN
            SELECT p.fecha_compra, COUNT(*) AS total_ventas
            FROM Pedido p
            GROUP BY p.fecha_compra
            ORDER BY total_ventas DESC
            LIMIT 1;

        -- Consulta 3: ¿Cuántos libros tenemos sobre un autor?
        WHEN 3 THEN
            SELECT a.nombre AS Autor, l.titulo_libro AS Libro, SUM(i.stock) AS stock
            FROM Autor a
            JOIN Escribe e ON e.id_autor = a.id_autor
            JOIN Libro l ON l.titulo_libro = e.titulo_libro
            JOIN Inventario i ON i.titulo_libro = l.titulo_libro
            WHERE a.nombre = parametro
            GROUP BY a.nombre, l.titulo_libro;

        -- Consulta 4: ¿Cuáles son las sucursales que poseen más libros?
        WHEN 4 THEN
            SELECT s.nombre AS Sucursal, SUM(i.stock) AS stock
            FROM Sucursal s
            JOIN Inventario i ON i.id_sucursal = s.id_sucursal
            GROUP BY Sucursal
            ORDER BY stock DESC;

        -- Consulta 5: ¿Cuál es el género más comprado en la comuna de "Santiago"?
        WHEN 5 THEN
            SELECT l.genero AS Genero
            FROM Libro l
            JOIN Pedido p ON p.titulo_libro = l.titulo_libro
            JOIN Cliente c ON c.id_cliente = p.id_cliente
            WHERE c.comuna = parametro;

        -- Consulta 6: ¿Cuáles son los géneros de libro más comprado?
        WHEN 6 THEN
            SELECT l.genero AS Genero, COUNT(*) AS total_compras
            FROM Libro l
            JOIN Pedido p ON p.titulo_libro = l.titulo_libro
            GROUP BY Genero
            ORDER BY total_compras DESC;

        -- Consulta 7: ¿Cuál es el libro que más se ha devuelto?
        WHEN 7 THEN
            SELECT d.titulo_libro, COUNT(*) AS total_devolucion
            FROM Devolucion d
            GROUP BY d.titulo_libro
            ORDER BY total_devolucion DESC
            LIMIT 1;

        -- Consulta 8: ¿Cuáles son los países que poseen más autores?
        WHEN 8 THEN
            SELECT a.pais_origen AS Pais_Autor, COUNT(*) AS cantidad_autores
            FROM Autor a
            GROUP BY Pais_Autor
            ORDER BY cantidad_autores DESC;

        -- Consulta 9: ¿Qué libros se han enviado más con envío?
        WHEN 9 THEN
            SELECT titulo_libro, COUNT(*) AS total_enviado
            FROM Envio
            GROUP BY titulo_libro
            ORDER BY total_enviado DESC;

        -- Consulta 10: ¿Cuál es el cliente que más ha comprado libros?
        WHEN 10 THEN
            SELECT c.nombre, COUNT(*) AS total_compras
            FROM Cliente c
            JOIN Pedido p ON p.id_cliente = c.id_cliente
            GROUP BY c.nombre
            ORDER BY total_compras DESC;

        -- Consulta 11: ¿Cuántos libros ha suministrado cada proveedor?
        WHEN 11 THEN
            SELECT p.nombre AS Proveedor, COUNT(s.titulo_libro) AS Libros_Suministrados
            FROM Proveedor p
            JOIN Suministra s ON p.id_proveedor = s.id_proveedor
            GROUP BY p.nombre
            ORDER BY Libros_Suministrados DESC;

        -- Consulta 12: ¿Cuál es la cantidad de libros suministrados por los proveedores entre Noviembre y Diciembre del 2024?
        WHEN 12 THEN
            SELECT p.nombre AS Proveedor, COUNT(s.titulo_libro) AS Libros_Suministrados
            FROM Proveedor p
            JOIN Suministra s ON p.id_proveedor = s.id_proveedor
            WHERE s.fecha_suministro BETWEEN '2024-11-01' AND '2024-12-31'
            GROUP BY p.nombre
            ORDER BY Libros_Suministrados DESC;

        -- Consulta 13: ¿Cuál es el sueldo promedio de los empleados en cada sucursal?
        WHEN 13 THEN
            SELECT s.nombre AS Sucursal, AVG(e.sueldo) AS Sueldo_Promedio
            FROM Sucursal s
            JOIN Empleado e ON s.id_sucursal = e.id_sucursal
            GROUP BY s.nombre
            ORDER BY Sueldo_Promedio DESC;

        -- Consulta 14: ¿Cuántos clientes tienen membresías activas por tipo?
        WHEN 14 THEN
            SELECT m.tipo AS Tipo_Membresia, COUNT(c.id_cliente) AS Total_Clientes
            FROM Membresia m
            JOIN Cliente c ON m.id_membresia = c.id_membresia
            GROUP BY m.tipo
            ORDER BY Total_Clientes DESC;

        -- Consulta 15: ¿Qué beneficios tienen los clientes con una membresía específica?
        WHEN 15 THEN
            SELECT m.tipo AS Tipo_Membresia, m.beneficios AS Beneficios
            FROM Membresia m
            WHERE m.tipo = parametro;
        
        ELSE
            SIGNAL SQLSTATE '45000'
            SET MESSAGE_TEXT = 'Consulta no válida.';
    END CASE;
END$$

DELIMITER ;

CALL ejecutarConsulta(15, 'Estandar'); -- Para consultar los beneficios de la membresía Estandar.
CALL ejecutarConsulta(3, 'James Clear'); -- Para consultar los libros relacionados con un autor.
CALL ejecutarConsulta(5, 'Santiago'); -- Para consultar el género más comprado en Santiago.

